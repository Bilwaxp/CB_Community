// This is your Prisma schema file
// Learn more at: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTH ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  nom           String
  prenom        String
  pseudo        String?   @unique
  bio           String?
  photo         String?
  phone         String?
  
  // Account status
  status        String   @default("PENDING")
  plan          String   @default("BASIC")
  role          String   @default("USER")
  
  // 2FA
  twoFactorEnabled   Boolean  @default(false)
  twoFactorSecret    String?
  
  // Social links
  twitter       String?
  instagram     String?
  telegram      String?
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  // Plan expiration
  planExpiresAt DateTime?
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  enrollments   Enrollment[]
  payments      Payment[]
  certificates  Certificate[]
  forumPosts    ForumPost[]
  forumReplies  ForumReply[]
  notifications Notification[]
  courseProgress CourseProgress[]
  videoSessions VideoSession[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String   @unique
  expires    DateTime
  type       String   @default("EMAIL_VERIFICATION")
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==================== COURSES ====================

model Course {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String
  thumbnail   String?
  price       Float    @default(0)
  currency    String   @default("USD")
  level       String   @default("BEGINNER")
  duration    Int      @default(0) // Total duration in minutes
  published   Boolean  @default(false)
  featured    Boolean  @default(false)
  
  // Access control
  isPremium   Boolean  @default(true)
  minPlan     String   @default("PRO")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  modules     Module[]
  enrollments Enrollment[]
  certificates Certificate[]

  @@map("courses")
}

model Module {
  id        String   @id @default(cuid())
  courseId  String
  title     String
  order     Int      @default(0)
  
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons   Lesson[]

  @@map("modules")
}

model Lesson {
  id          String      @id @default(cuid())
  moduleId    String
  title       String
  description String?
  type        String  @default("VIDEO")
  order       Int         @default(0)
  duration    Int         @default(0) // Duration in minutes
  
  // Content
  videoUrl    String?
  videoHlsUrl String?     // HLS streaming URL
  pdfUrl      String?
  imageUrl    String?
  audioUrl    String?
  content     String?     // For text/html content
  
  // Subtitles
  subtitlesUrl String?
  
  // Quiz data (JSON stored as String)
  quizData    String?
  
  isFree      Boolean     @default(false)
  published   Boolean     @default(true)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  module      Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress    CourseProgress[]
  comments    LessonComment[]

  @@map("lessons")
}

model Enrollment {
  id         String   @id @default(cuid())
  userId     String
  courseId   String
  progress   Float    @default(0) // Percentage 0-100
  completed  Boolean  @default(false)
  completedAt DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

model CourseProgress {
  id         String   @id @default(cuid())
  userId     String
  lessonId   String
  completed  Boolean  @default(false)
  watchTime  Int      @default(0) // Seconds watched
  lastPosition Int    @default(0) // Last video position in seconds
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson     Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("course_progress")
}

model LessonComment {
  id        String   @id @default(cuid())
  lessonId  String
  userId    String
  content   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("lesson_comments")
}

// ==================== PAYMENTS ====================

model Payment {
  id             String        @id @default(cuid())
  userId         String
  amount         Float
  currency       String        @default("USD")
  method         String
  status         String @default("PENDING")
  
  // Type of payment
  type           String   @default("SUBSCRIPTION")
  planType       String?
  courseId       String?
  
  // Payment provider details
  stripeSessionId    String?
  stripePaymentIntent String?
  paypalOrderId      String?
  moncashTransactionId String?
  natcashTransactionId String?
  cryptoTxHash       String?
  
  // Invoice
  invoiceUrl     String?
  invoicePdfUrl  String?
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Coupon {
  id          String   @id @default(cuid())
  code        String   @unique
  discount    Float    // Percentage (0-100)
  maxUses     Int?
  usedCount   Int      @default(0)
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())

  @@map("coupons")
}

// ==================== CERTIFICATES ====================

model Certificate {
  id          String   @id @default(cuid())
  uniqueId    String   @unique @default(cuid())
  userId      String
  courseId    String
  
  pdfUrl      String?
  qrCodeUrl   String?
  
  issuedAt    DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("certificates")
}

// ==================== SIGNALS ====================

model Signal {
  id          String      @id @default(cuid())
  title       String
  category    String
  pair        String      // e.g., "BTC/USDT", "EUR/USD"
  action      String
  entryPrice  Float
  stopLoss    Float
  takeProfit  String      // Multiple TP levels stored as JSON string
  
  analysis    String?
  imageUrl    String?
  
  status      String @default("ACTIVE")
  result      String?
  resultPips  Float?
  
  isPremium   Boolean     @default(true)
  publishedAt DateTime    @default(now())
  expiresAt   DateTime?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("signals")
}

// ==================== FORUM ====================

model ForumCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  order       Int      @default(0)
  
  threads     ForumThread[]

  @@map("forum_categories")
}

model ForumThread {
  id          String   @id @default(cuid())
  categoryId  String
  title       String
  slug        String   @unique
  isPinned    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  viewCount   Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  category    ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  posts       ForumPost[]

  @@map("forum_threads")
}

model ForumPost {
  id        String   @id @default(cuid())
  threadId  String
  userId    String
  content   String
  isFirst   Boolean  @default(false) // First post = thread content
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  thread    ForumThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  replies   ForumReply[]
  likes     ForumLike[]
  reports   ForumReport[]

  @@map("forum_posts")
}

model ForumReply {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("forum_replies")
}

model ForumLike {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  
  createdAt DateTime @default(now())
  
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("forum_likes")
}

model ForumReport {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  reason    String
  status    String @default("PENDING")
  
  createdAt DateTime @default(now())
  
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("forum_reports")
}

// ==================== VIDEO SESSIONS ====================

model VideoSession {
  id          String   @id @default(cuid())
  title       String
  description String?
  hostId      String
  
  type        String @default("WEBINAR")
  status      String @default("SCHEDULED")
  
  // Access
  minPlan     String @default("PRO")
  maxParticipants Int @default(100)
  
  // Schedule
  scheduledAt DateTime
  startedAt   DateTime?
  endedAt     DateTime?
  duration    Int?     // Actual duration in minutes
  
  // Room
  roomId      String   @unique
  roomToken   String?
  
  // Recording
  recordingUrl String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  host        User     @relation(fields: [hostId], references: [id])
  participants SessionParticipant[]

  @@map("video_sessions")
}

model SessionParticipant {
  id        String   @id @default(cuid())
  sessionId String
  userId    String
  joinedAt  DateTime @default(now())
  leftAt    DateTime?
  
  session   VideoSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@map("session_participants")
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  read      Boolean  @default(false)
  link      String?
  
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ==================== SITE SETTINGS ====================

model SiteSettings {
  id          String @id @default("settings")
  siteName    String @default("CB_Community")
  logo        String?
  favicon     String?
  
  // Colors (JSON stored as String)
  colors      String?
  
  // Content (JSON stored as String)
  homeContent String?
  aboutContent String?
  
  // Social links
  twitter     String?
  instagram   String?
  telegram    String?
  youtube     String?
  
  // Contact
  supportEmail String?
  
  // API Keys (encrypted)
  stripeKey   String?
  agoraAppId  String?
  
  // SMTP
  smtpHost    String?
  smtpPort    Int?
  smtpUser    String?
  smtpPass    String?
  
  updatedAt   DateTime @updatedAt

  @@map("site_settings")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  metadata  String?
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// ==================== UPLOADS ====================

model Upload {
  id          String   @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  
  type        String
  isPublic    Boolean  @default(false)
  
  uploadedBy  String?
  
  createdAt   DateTime @default(now())

  @@map("uploads")
}

// ==================== ENUMS (Converted to String for SQLite) ====================
// Note: SQLite doesn't support enums, so we use String types with default values
// Valid values are documented in comments below:

// UserStatus: "PENDING" | "APPROVED" | "SUSPENDED" | "BANNED"
// PlanType: "BASIC" | "PRO" | "VIP"
// Role: "USER" | "ADMIN"
// CourseLevel: "BEGINNER" | "INTERMEDIATE" | "ADVANCED"
// LessonType: "VIDEO" | "PDF" | "IMAGE" | "AUDIO" | "QUIZ" | "TEXT"
// PaymentMethod: "STRIPE" | "PAYPAL" | "MONCASH" | "NATCASH" | "CRYPTO_USDT" | "CRYPTO_BTC"
// PaymentStatus: "PENDING" | "COMPLETED" | "FAILED" | "REFUNDED" | "CANCELLED"
// PaymentType: "SUBSCRIPTION" | "COURSE" | "ONE_TIME"
// SignalCategory: "FOREX" | "CRYPTO"
// SignalAction: "BUY" | "SELL"
// SignalStatus: "ACTIVE" | "CLOSED" | "EXPIRED"
// SignalResult: "WIN" | "LOSS" | "BREAKEVEN"
// SessionType: "ONE_ON_ONE" | "WEBINAR"
// SessionStatus: "SCHEDULED" | "LIVE" | "ENDED" | "CANCELLED"
// NotificationType: "SYSTEM" | "COURSE" | "PAYMENT" | "SIGNAL" | "FORUM" | "VIDEO_SESSION"
// ReportStatus: "PENDING" | "REVIEWED" | "RESOLVED" | "DISMISSED"
// TokenType: "EMAIL_VERIFICATION" | "PASSWORD_RESET" | "TWO_FACTOR"
// UploadType: "VIDEO" | "PDF" | "IMAGE" | "AUDIO" | "CERTIFICATE" | "INVOICE"






